name: AI Security Audit

on:
  workflow_run:
    workflows: ["Application CI/CD Pipeline"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: read

jobs:
  ai-security-audit:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install requests openai
      
      - name: Download Trivy Results
        uses: actions/download-artifact@v4
        with:
          name: trivy-scan-results
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      
      - name: Generate JSON Report
        run: |
          # Convert SARIF to JSON for GPT analysis
          if [ -f "trivy-results.sarif" ]; then
            echo "Converting SARIF to JSON..."
            python -c "
import json
with open('trivy-results.sarif', 'r') as f:
    sarif = json.load(f)
    
# Extract vulnerabilities from SARIF
results = {'Results': []}
for run in sarif.get('runs', []):
    for result in run.get('results', []):
        vuln = {
            'VulnerabilityID': result.get('ruleId', 'Unknown'),
            'Severity': result.get('level', 'unknown').upper(),
            'PkgName': result.get('locations', [{}])[0].get('physicalLocation', {}).get('artifactLocation', {}).get('uri', 'Unknown'),
            'Title': result.get('message', {}).get('text', 'No title'),
            'Description': result.get('help', {}).get('text', 'No description')
        }
        results['Results'].append({'Vulnerabilities': [vuln]})

with open('trivy-results.json', 'w') as f:
    json.dump(results, f, indent=2)
"
          else
            echo "No SARIF file found, creating empty results"
            echo '{"Results": []}' > trivy-results.json
          fi
      
      - name: Run AI Security Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/security-gpt-analyzer.py
      
      - name: Create Security Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let reportContent = "No security report generated.";
            try {
              reportContent = fs.readFileSync('security-audit-report.md', 'utf8');
            } catch (error) {
              console.log('No report file found');
            }
            
            // Create or update security issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'ai-audit'],
              state: 'open'
            });
            
            const issueBody = `
## ü§ñ AI Security Audit Report
            
${reportContent}
            
---
*Generated by Security Auditor GPT on ${new Date().toISOString()}*
*Workflow: ${context.workflow} | Run: ${context.runNumber}*
            `;
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: issueBody
              });
              console.log(`Updated security issue #${issues[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üõ°Ô∏è AI Security Audit - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['security', 'ai-audit', 'enhancement']
              });
              console.log('Created new security audit issue');
            }
      
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-security-report
          path: security-audit-report.md